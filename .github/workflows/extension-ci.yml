name: Extension CI

on:
  push:
    branches:
      - main
      - master
    tags:
      - "v*.*.*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install web-ext
        run: npm install -g web-ext

      - name: Run lint
        run: web-ext lint --source-dir aria-ai-assistant

  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      ext_version: ${{ steps.meta.outputs.ext_version }}
      short_sha: ${{ steps.meta.outputs.short_sha }}
      zip_name: ${{ steps.meta.outputs.zip_name }}
      xpi_name: ${{ steps.meta.outputs.xpi_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq zip
          npm install -g web-ext

      - name: Build XPI
        run: web-ext build --source-dir aria-ai-assistant --artifacts-dir dist --overwrite-dest

      - name: Prepare release artifacts
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(jq -r '.version' aria-ai-assistant/manifest.json)"
          SHORT_SHA="${GITHUB_SHA::7}"
          PACKAGE_SOURCE="$(find dist -maxdepth 1 -type f \( -name '*.xpi' -o -name '*.zip' \) | sort | head -n1)"
          test -n "$PACKAGE_SOURCE"

          ZIP_NAME="aria-ai-assistant-${VERSION}-${SHORT_SHA}.zip"
          XPI_NAME="aria-ai-assistant-${VERSION}-${SHORT_SHA}.xpi"

          # web-ext may output either .xpi or .zip depending on version/runtime.
          # For Thunderbird distribution we publish a deterministic .xpi filename.
          cp "$PACKAGE_SOURCE" "dist/${XPI_NAME}"
          (
            cd aria-ai-assistant
            zip -r "../dist/${ZIP_NAME}" .
          )

          echo "ext_version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "short_sha=${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          echo "zip_name=${ZIP_NAME}" >> "$GITHUB_OUTPUT"
          echo "xpi_name=${XPI_NAME}" >> "$GITHUB_OUTPUT"

          ls -lah dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extension-artifacts
          path: dist/
          if-no-files-found: error

  release-commit:
    name: Release (Commit Builds)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-artifacts
          path: dist

      - name: Publish commit release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: build-${{ github.sha }}
          name: ARIA automatic build ${{ needs.build.outputs.short_sha }}
          body: |
            Automatic release from commit `${{ github.sha }}`.

            Extension version: `${{ needs.build.outputs.ext_version }}`
            Branch: `${{ github.ref_name }}`
          prerelease: true
          allowUpdates: true
          artifacts: dist/${{ needs.build.outputs.zip_name }},dist/${{ needs.build.outputs.xpi_name }}
          artifactErrorsFailBuild: true

  release-tag:
    name: Release (Tags)
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: extension-artifacts
          path: dist

      - name: Publish tag release
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref_name }}
          name: ARIA ${{ github.ref_name }}
          body: |
            Official tagged release `${{ github.ref_name }}`.
            Extension version: `${{ needs.build.outputs.ext_version }}`
          prerelease: false
          allowUpdates: true
          artifacts: dist/${{ needs.build.outputs.zip_name }},dist/${{ needs.build.outputs.xpi_name }}
          artifactErrorsFailBuild: true
