stages:
  - test
  - build
  - release

variables:
  WEB_EXT_SOURCE_DIR: "aria-ai-assistant"
  WEB_EXT_ARTIFACTS_DIR: "dist"

# Test stage: Lint and validate the extension
lint:
  stage: test
  image: node:18-alpine
  before_script:
    - npm install -g web-ext
  script:
    - web-ext lint --source-dir $WEB_EXT_SOURCE_DIR
  only:
    - main
    - merge_requests
    - tags

# Build stage: Package the extension into XPI
build:
  stage: build
  image: node:18-alpine
  before_script:
    - npm install -g web-ext
  script:
    - web-ext build --source-dir $WEB_EXT_SOURCE_DIR --overwrite-dest
  artifacts:
    paths:
      - $WEB_EXT_ARTIFACTS_DIR/
    expire_in: 1 week
  only:
    - main
    - tags

# Version bump job: Automatically increment patch version on push to main
# WARNING: This requires setting a CI/CD variable GITLAB_TOKEN (Project Access Token with write_repository scope)
# in GitLab settings. It updates manifest.json, commits, and pushes back. Use with caution to avoid loops.
# For better practice, use semantic-release or manual tags for versions.
version-bump:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache git nodejs npm jq
    - npm install -g web-ext
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
  script:
    - |
      # Extract current version from manifest.json
      CURRENT_VERSION=$(cat $WEB_EXT_SOURCE_DIR/manifest.json | jq -r '.version')
      echo "Current version: $CURRENT_VERSION"
      
      # Increment patch version (e.g., 1.0.0 -> 1.0.1)
      NEW_VERSION=$(echo $CURRENT_VERSION | awk -F. '{print $1"."$2"."($3+1)}')
      echo "New version: $NEW_VERSION"
      
      # Update manifest.json
      jq ".version = \"$NEW_VERSION\"" $WEB_EXT_SOURCE_DIR/manifest.json > $WEB_EXT_SOURCE_DIR/manifest.json.tmp && mv $WEB_EXT_SOURCE_DIR/manifest.json.tmp $WEB_EXT_SOURCE_DIR/manifest.json
      
      # Commit and push if changed
      git add $WEB_EXT_SOURCE_DIR/manifest.json
      if git diff --staged --quiet; then
        echo "No version change needed"
      else
        git commit -m "ci: bump version to $NEW_VERSION [skip ci]"
        git remote set-url origin https://oauth2:$GITLAB_TOKEN@gitlab.com/thunderbird-extension/ai-mail-assistant.git  # Adjust repo URL
        git push origin HEAD:main
      fi
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: on_success
  only:
    - main

# Release stage: On tags (e.g., v1.0.1), create ZIP archive and artifact
# This runs after build on tags. Version from tag or manifest.
release:
  stage: release
  image: node:18-alpine
  dependencies:
    - build
  script:
    - |
      # Create ZIP archive of the extension (alternative to XPI)
      cd $WEB_EXT_SOURCE_DIR
      zip -r ../aria-ai-assistant-$CI_COMMIT_TAG.zip .
      cd ..
    - echo "Release artifact created: aria-ai-assistant-$CI_COMMIT_TAG.zip"
    # Optionally: Use GitLab API to create release (requires token)
    # curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases" ...
  artifacts:
    paths:
      - aria-ai-assistant-*.zip
      - dist/
    expire_in: 1 month
  only:
    - tags

# Default job for pushes/tags: Run test and build
default:
  image: node:18-alpine
  before_script:
    - npm install -g web-ext
